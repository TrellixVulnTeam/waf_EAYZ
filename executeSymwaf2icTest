#!/bin/bash -e

# File:         executeSymwaf2icTest
# Author:       Kai Husmann <kai.husmann@kip.uni-heidelberg.de> (KHS)
# Changelog:    [2015-04-17 15:02:21]   created/released (KHS)
#               [2015-04-17 15:02:37]   now hiding make (KHS)
# --- chlog insert above ---


# PREREQUISITES
TESTS="$@"
TESTS=${TESTS:-"default"}
#TESTFOLDER="/tmp/symtest" # TODO: does not work -> waf is loosing some leading slash...
TESTFOLDER="$HOME/test/symtest"
OUR_ZONES="symwaf2ic,symwaf2ic_options,dependency,mr"


test -f "waf-light" || { echo "ERR: looks like we're executed in the wrong directory."; exit 1; }

mkdir -p $TESTFOLDER
ln -sf $PWD/waf $TESTFOLDER/waf


# TEST FUNCTIONS
function test_default { # just t
    ./waf setup --project hicann-system --zones $OUR_ZONES
}
function test_dependency {
   ./waf setup --project halbe --zones symwaf2ic,symwaf2ic_dependency --with-ess
}
function test_reset {
    test -d halbe && { pushd halbe; git checkout -f ess_trafo; echo "fu" >> project.prj; popd; }
    ./waf setup --project halbe --update-branches soft --zones symwaf2ic,mr \
        && { echo "SHOULD HAVE FAILED"; exit 1; } \
        || { echo -e "FAILURE EXPECTED AND GOOD\n\n"; }
    ./waf setup --project halbe --update-branches force --zones symwaf2ic,mr
}

# COMBI TESTS
function test_super {
    run_tests default dependency reset
}

# BUILDING SYMWAF2IC
function run_build {
    make > $TESTFOLDER/make.log 2> $TESTFOLDER/make.err
    ERR=$?
    if [ $ERR -ne 0 ]
    then
        cat $TESTFOLDER/make.log
        cat $TESTFOLDER/make.err
        return 1
    fi
    echo "BUILD: symwaf2ic-waf rebuild successfully."
    echo
}

# TESTING SYMWAF2IC
function run_tests {
    set +o xtrace
    for i in "$@"
    do
        echo -e "\nEXECUTING TEST $i"
        cd $TESTFOLDER

        set -o xtrace
        test_$i
        set +o xtrace
        echo -e "\n############################################################\n"
    done
}

run_build || { echo "ERR: make failed, aborting test!"; exit 1; }

run_tests $TESTS
